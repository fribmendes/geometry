#!/usr/bin/env zsh
GEOMETRY_ROOT="${0:A:h:h}"
TARGET=$GEOMETRY_ROOT/build/geometry.zsh

echo Removing target: $TARGET
[[ -f $TARGET ]] && rm $TARGET 

echo Compiling into a single file...
echo "# This file was autogenerated by \`bin/compile\`. Do not edit it directly!" > $TARGET
echo "# $(date --rfc-2822)"         >> $TARGET
cat $GEOMETRY_ROOT/lib/*.zsh        >> $TARGET
cat $GEOMETRY_ROOT/plugins/*/*.zsh  >> $TARGET
echo

echo "--> Disable self-register"
sed -i "s/geometry_plugin_register /# Disabled: geometry_plugin_register/" $TARGET

echo "--> Register default plugin"
sed -i "s/source .*/geometry_plugin_register \$plugin/" $TARGET

echo "--> Disable sourcing lib"
cat $GEOMETRY_ROOT/geometry.zsh     >> $TARGET
sed -i "s/source/# Disabled: source/" $TARGET

echo
echo Built: $TARGET
echo Done!
